<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:BuzzahBuddy.ViewModels"
             xmlns:models="clr-namespace:BuzzahBuddy.Models"
             x:Class="BuzzahBuddy.Views.DeviceListPage"
             x:DataType="vm:DeviceListViewModel"
             Title="{Binding Title}">

    <Grid RowDefinitions="Auto,*,Auto" Padding="20">

        <!-- Header Info -->
        <VerticalStackLayout Grid.Row="0" Spacing="10" Margin="0,0,0,20">
            <Label Text="Available Devices"
                   Style="{StaticResource Headline}"
                   SemanticProperties.HeadingLevel="Level1" />

            <Label Text="Scan for nearby BlueBuzzah gloves"
                   FontSize="16"
                   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                   IsVisible="{Binding BluetoothEnabled}"
                   LineBreakMode="WordWrap"
                   SemanticProperties.Description="Instructions for scanning" />

            <Label Text="Bluetooth is disabled. Please enable Bluetooth to scan for devices."
                   FontSize="16"
                   TextColor="{StaticResource Danger}"
                   IsVisible="{Binding BluetoothEnabled, Converter={StaticResource InvertedBoolConverter}}"
                   LineBreakMode="WordWrap"
                   SemanticProperties.Description="Bluetooth disabled warning" />
        </VerticalStackLayout>

        <!-- Device List -->
        <CollectionView Grid.Row="1"
                        ItemsSource="{Binding AvailableDevices}"
                        SelectionMode="None">
            <CollectionView.EmptyView>
                <ContentView>
                    <Label Text="No devices found. Tap 'Scan' to search for BlueBuzzah gloves."
                           FontSize="16"
                           HorizontalTextAlignment="Center"
                           VerticalTextAlignment="Center"
                           LineBreakMode="WordWrap"
                           Padding="20"
                           TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                           SemanticProperties.Description="No devices found message" />
                </ContentView>
            </CollectionView.EmptyView>
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:GloveDevice">
                    <Border Padding="15"
                            Margin="0,0,0,10"
                            BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray900}}"
                            StrokeThickness="0">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="12" />
                        </Border.StrokeShape>

                        <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto,Auto">
                            <Label Grid.Row="0" Grid.Column="0"
                                   Text="{Binding Name}"
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   SemanticProperties.Description="Device name" />

                            <Label Grid.Row="1" Grid.Column="0"
                                   Text="{Binding Id}"
                                   FontSize="12"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                                   SemanticProperties.Description="Device identifier" />

                            <Label Grid.Row="2" Grid.Column="0"
                                   Text="{Binding SignalStrength, StringFormat='Signal: {0} dBm'}"
                                   FontSize="12"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />

                            <Button Grid.Row="0" Grid.RowSpan="3" Grid.Column="1"
                                    Text="Connect"
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DeviceListViewModel}}, Path=ConnectCommand}"
                                    CommandParameter="{Binding .}"
                                    HeightRequest="48"
                                    WidthRequest="100"
                                    CornerRadius="8"
                                    VerticalOptions="Center"
                                    SemanticProperties.Hint="Connect to this device"
                                    AutomationId="ConnectDeviceButton" />
                        </Grid>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Scan Button -->
        <VerticalStackLayout Grid.Row="2" Spacing="10">
            <ActivityIndicator IsRunning="{Binding IsScanning}"
                               IsVisible="{Binding IsScanning}"
                               HeightRequest="40"
                               SemanticProperties.Description="Scanning for devices" />

            <Button Text="Scan for Devices"
                    Command="{Binding ScanCommand}"
                    IsVisible="{Binding IsScanning, Converter={StaticResource InvertedBoolConverter}}"
                    HeightRequest="56"
                    FontSize="18"
                    CornerRadius="12"
                    SemanticProperties.Hint="Start scanning for BlueBuzzah gloves"
                    SemanticProperties.Description="Scan for available devices"
                    AutomationId="ScanButton" />

            <Button Text="Stop Scanning"
                    Command="{Binding StopScanCommand}"
                    IsVisible="{Binding IsScanning}"
                    HeightRequest="56"
                    FontSize="18"
                    CornerRadius="12"
                    BackgroundColor="{AppThemeBinding Light={StaticResource PastelDanger}, Dark={StaticResource PastelDangerDark}}"
                    SemanticProperties.Hint="Stop the current scan"
                    AutomationId="StopScanButton" />
        </VerticalStackLayout>

    </Grid>

</ContentPage>
